#ê°™ì€ íŒŒì¼ ë‚´ì— db(ì‚¬ì§„ íŒŒì¼) ë‘ê³  ì‚¬ì§„ ì´ë¦„ ì˜ì–´ë¡œ ì„¤ì •


import streamlit as st
import cv2
import numpy as np
from deepface import DeepFace
import os
import traceback

st.set_page_config(page_title="ì£¼ì„±ê³ ë“±í•™êµ ë™ì•„ë¦¬ ì½”ì‹¸ì¸", layout="centered")

# ---------------- ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” ----------------
if "page" not in st.session_state:
    st.session_state.page = "home"
if "last_image_path" not in st.session_state:
    st.session_state.last_image_path = None
if "last_analysis" not in st.session_state:
    st.session_state.last_analysis = None

st.markdown("<h1 style='text-align:center;'>ì–¼êµ´ ì¸ì‹ ì¸ê³µì§€ëŠ¥</h1>", unsafe_allow_html=True)

# ---------------- í™ˆ í˜ì´ì§€ ----------------
if st.session_state.page == "home":
    st.markdown("""
        <div style='margin-bottom:10px; padding:20px; border-radius:15px; background-color:#f0f9ff; text-align:center;'>
            <p>ë”¥ëŸ¬ë‹ ê¸°ë°˜ DeepFaceë¥¼ ì´ìš©í•œ ì–¼êµ´ ì¸ì‹ì…ë‹ˆë‹¤.</p>
        </div>
    """, unsafe_allow_html=True)

    if st.button("ì‚¬ì§„ ì°ì–´ ë¶„ì„"):
        st.session_state.page = "camera_internal"
        st.rerun()

# ---------------- ì¹´ë©”ë¼ í˜ì´ì§€ ----------------
elif st.session_state.page == "camera_internal":
    st.markdown("<h3 style='text-align:center;'>ì‚¬ì§„ ì°ì–´ ë¶„ì„í•˜ê¸°</h3>", unsafe_allow_html=True)
    uploaded_image = st.camera_input("ì¹´ë©”ë¼ë¡œ ì‚¬ì§„ì„ ì°ì–´ì£¼ì„¸ìš”")

    if uploaded_image is not None:
        try:
            # OpenCV ì´ë¯¸ì§€ë¡œ ë³€í™˜
            file_bytes = np.asarray(bytearray(uploaded_image.read()), dtype=np.uint8)
            img_bgr = cv2.imdecode(file_bytes, cv2.IMREAD_COLOR)

            if img_bgr is not None:
                # íŒŒì¼ë¡œ ì €ì¥
                image_path = "captured_image.jpg"
                cv2.imwrite(image_path, img_bgr)
                st.session_state.last_image_path = image_path

                try:
                    # ageì™€ genderë§Œ ë¶„ì„
                    result = DeepFace.analyze(
                        img_path=image_path,
                        actions=["age", "gender"],
                        enforce_detection=False
                    )

                    if isinstance(result, list) and len(result) > 0:
                        d = result[0]
                    elif isinstance(result, dict):
                        d = result
                    else:
                        d = None

                    # ğŸ‘‡ ëˆˆ ê°’ null ì²´í¬ (None ì´ë©´ ê²½ê³ )
                    if d is not None:
                        left_eye = d.get("region", {}).get("left_eye")
                        right_eye = d.get("region", {}).get("right_eye")

                        if left_eye is None or right_eye is None:
                            st.warning("ëˆˆ ìœ„ì¹˜ë¥¼ ê°ì§€í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì‚¬ì§„ì„ ë‹¤ì‹œ ì°ì–´ì£¼ì„¸ìš”.")
                            d = None  # ì €ì¥í•˜ì§€ ì•ŠìŒ
                        else:
                            st.success("ë¶„ì„ ì™„ë£Œ!")  # âœ… ë¶„ì„ ì„±ê³µ ë©”ì‹œì§€

                    st.session_state.last_analysis = d

                except Exception as e:
                    st.error(f"DeepFace ë¶„ì„ ì˜¤ë¥˜: {e}")
                    traceback.print_exc()
            else:
                st.error("ì´ë¯¸ì§€ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

        except Exception as e:
            st.error(f"ì´ë¯¸ì§€ ì²˜ë¦¬ ì˜¤ë¥˜: {e}")
            traceback.print_exc()

    st.markdown("---")
    col1, col2 = st.columns(2)
    with col1:
        if st.button("ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ì´ë™"):
            st.session_state.page = "result"
            st.rerun()
    with col2:
        if st.button("ë’¤ë¡œê°€ê¸°"):
            st.session_state.page = "home"
            st.rerun()

# ---------------- ê²°ê³¼ í˜ì´ì§€ ----------------
elif st.session_state.page == "result":
    st.markdown("<h2 style='text-align:center;'>\nê²°ê³¼ í™”ë©´</h2>", unsafe_allow_html=True)

    # ë‹®ì€ê¼´ ì°¾ê¸°
    if st.button("ë‹®ì€ê¼´ ì°¾ê¸°"):
        if st.session_state.last_image_path is None:
            st.error("ë¶„ì„í•  ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.")
        else:
            try:
                db_path = "db"  # DB í´ë” (ì–¼êµ´ ì´ë¯¸ì§€ ì—¬ëŸ¬ ì¥ ë„£ê¸°)
                if not os.path.exists(db_path):
                    st.warning("DB í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤. db í´ë”ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.")
                else:
                    df = DeepFace.find(
                        img_path=st.session_state.last_image_path,
                        db_path=db_path,
                        model_name="VGG-Face",
                        enforce_detection=False
                    )

                    if df and len(df) > 0 and not df[0].empty:
                        best_match = df[0].iloc[0]  # ê°€ì¥ ë‹®ì€ ì´ë¯¸ì§€
                        st.success(f"ë‹®ì€ ì‚¬ëŒ: {os.path.basename(best_match['identity'])}")
                        st.image(best_match['identity'], caption="ë‹®ì€ê¼´ ì‚¬ì§„", use_container_width=True)
                    else:
                        st.warning("DBì—ì„œ ë‹®ì€ê¼´ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ì–¼êµ´ ê°ì§€ ì‹¤íŒ¨ ê°€ëŠ¥)")

            except Exception as e:
                st.error(f"ë‹®ì€ê¼´ ì°¾ê¸° ì˜¤ë¥˜: {e}")
                traceback.print_exc()

    # ë¯¸ë˜ ì–¼êµ´ ë³´ê¸°
    if st.button("ë¯¸ë˜ ì–¼êµ´ ë³´ê¸°"):
        st.warning("ë¯¸ë˜ ì–¼êµ´ ê¸°ëŠ¥ì€ ë³„ë„ face-aging ëª¨ë¸ì´ í•„ìš”í•©ë‹ˆë‹¤.")

    # ë‹¤ë¥¸ ì„±ë³„ ì–¼êµ´
    if st.button("ì„±ë³„ ë°”ê¾¸ê¸°"):
        st.warning("ì„±ë³„ ë³€í™˜ ê¸°ëŠ¥ì€ ë³„ë„ ëª¨ë¸ì´ í•„ìš”í•©ë‹ˆë‹¤.")

    if st.button("í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°"):
        st.session_state.page = "home"
        st.rerun()
